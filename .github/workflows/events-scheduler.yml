name: Events Scheduler

on:
  schedule:
    - cron: "5 0 * * 1"
    - cron: "10 0 1 * *"
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      runWeekly:
        description: "Force weekly events"
        required: false
        default: "false"
      runMonthly:
        description: "Force monthly events"
        required: false
        default: "false"
      runEmailDispatch:
        description: "Force email dispatch"
        required: false
        default: "false"

jobs:
  trigger-events:
    runs-on: ubuntu-latest
    env:
      EVENTS_BASE_URL: ${{ secrets.EVENTS_BASE_URL || secrets.FRONTEND_URL }}
      EVENTS_CRON_SECRET: ${{ secrets.EVENTS_CRON_SECRET }}
      WEEKLY_SCHEDULE: "5 0 * * 1"
      MONTHLY_SCHEDULE: "10 0 1 * *"
      EMAIL_SCHEDULE: "*/15 * * * *"
    steps:
      - name: Validate base URL
        run: |
          if [ -z "${EVENTS_BASE_URL}" ]; then
            echo "::error::Set either EVENTS_BASE_URL or FRONTEND_URL secret to your deployed host (e.g. https://vertic-id.com)." >&2
            exit 1
          fi

      - name: Trigger weekly events
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.runWeekly == 'true' || github.event.schedule == env.WEEKLY_SCHEDULE }}
        run: |
          curl --fail --show-error --silent -X POST \
            -H "Authorization: Bearer ${EVENTS_CRON_SECRET}" \
            "${EVENTS_BASE_URL}/api/events/weekly"

      - name: Trigger monthly events
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.runMonthly == 'true' || github.event.schedule == env.MONTHLY_SCHEDULE }}
        run: |
          curl --fail --show-error --silent -X POST \
            -H "Authorization: Bearer ${EVENTS_CRON_SECRET}" \
            "${EVENTS_BASE_URL}/api/events/monthly"

      - name: Dispatch emails
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.runEmailDispatch == 'true' || github.event.schedule == env.EMAIL_SCHEDULE }}
        run: |
          curl --fail --show-error --silent -X POST \
            -H "Authorization: Bearer ${EVENTS_CRON_SECRET}" \
            "${EVENTS_BASE_URL}/api/events/emails/dispatch"
